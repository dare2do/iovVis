{
  "ruleChain": {
    "additionalInfo": null,
    "name": "CONFIG_WARNING_RULE",
    "firstRuleNodeId": null,
    "root": false,
    "debugMode": false,
    "configuration": null
  },
  "metadata": {
    "firstNodeIndex": 0,
    "nodes": [
      {
        "additionalInfo": {
          "layoutX": 274,
          "layoutY": 150
        },
        "type": "org.thingsboard.rule.engine.transform.TbChangeOriginatorNode",
        "name": "传感量所属资产",
        "debugMode": false,
        "configuration": {
          "originatorSource": "RELATED",
          "relationsQuery": {
            "direction": "TO",
            "maxLevel": 1,
            "filters": [
              {
                "relationType": "Contains",
                "entityTypes": [
                  "ASSET"
                ]
              }
            ]
          }
        }
      },
      {
        "additionalInfo": {
          "layoutX": 584,
          "layoutY": 149,
          "description": "每个传感器的ID作为资产的属性id，true表示发生告警。记录的是资产的告警时间点序列数据。"
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "保存资产时间序列",
        "debugMode": false,
        "configuration": {
          "jsScript": "// msgType = 'POST_ATTRIBUTES_REQUEST';\nmsg[metadata.dev_id] = 'true';\nmetadata = {};\n// msg.bridge_warning_level = 'RED';\nreturn {msg: msg, metadata: metadata, msgType: msgType};"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 51,
          "layoutY": 330
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetAttributesNode",
        "name": "获取所有规则需要的属性",
        "debugMode": false,
        "configuration": {
          "clientAttributeNames": [],
          "sharedAttributeNames": [],
          "serverAttributeNames": [],
          "latestTsKeyNames": [
            "280f1810-1104-11e9-bae8-7562662cc4ee",
            "b566b7e0-1104-11e9-bae8-7562662cc4ee",
            "string",
            "35b34650-2f3e-11e9-8052-a16fddffa555",
            "1bc37430-2f3f-11e9-b45b-bf80d2af7be9"
          ]
        }
      },
      {
        "additionalInfo": {
          "layoutX": 479,
          "layoutY": 245
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode",
        "name": "保存到时间序列",
        "debugMode": false,
        "configuration": {
          "defaultTTL": 0
        }
      },
      {
        "additionalInfo": {
          "layoutX": 892,
          "layoutY": 147
        },
        "type": "org.thingsboard.rule.engine.metadata.TbGetOriginatorFieldsNode",
        "name": "获取资产id",
        "debugMode": false,
        "configuration": {
          "fieldsMapping": {
            "name": "originatorName",
            "type": "originatorType",
            "id": "asset_id"
          }
        }
      },
      {
        "additionalInfo": {
          "layoutX": 366,
          "layoutY": 333
        },
        "type": "org.thingsboard.rule.engine.filter.TbJsSwitchNode",
        "name": "预警规则设置",
        "debugMode": false,
        "configuration": {
          "jsScript": "var ruleTables = {\"265c7510-1df4-11e9-b372-db8be707c5f4\":{\"blueRules\":[{\"andRule\":[\"280f1810-1104-11e9-bae8-7562662cc4ee\",\"b566b7e0-1104-11e9-bae8-7562662cc4ee\"]},{\"andRule\":[\"280f1810-1104-11e9-bae8-7562662cc4ee\",\"b566b7e0-1104-11e9-bae8-7562662cc4ee\"]}],\"orangeRules\":[]},\"cd59be20-12fc-11e9-bae8-7562662cc4ee\":{\"blueRules\":[],\"orangeRules\":[{\"andRule\":[]}]},\"erqweqweqweq\":{\"blueRules\":[{\"andRule\":[\"string\"]}],\"orangeRules\":[{\"andRule\":[\"string\"]}]},\"fe06e520-1a63-11e9-81c9-97b575a68222\":{\"blueRules\":[{\"andRule\":[\"35b34650-2f3e-11e9-8052-a16fddffa555\"]},{\"andRule\":[\"1bc37430-2f3f-11e9-b45b-bf80d2af7be9\"]}],\"orangeRules\":[{\"andRule\":[\"1bc37430-2f3f-11e9-b45b-bf80d2af7be9\",\"35b34650-2f3e-11e9-8052-a16fddffa555\"]}]}};\n/* warning rule tables */\nfunction tryRules(assetId, msg) {\n    //check orangeRules first, then blueRules\n    if (ruleTables[assetId]) {\n        blueRules = ruleTables[assetId].blueRules;\n        orangeRules = ruleTables[assetId].orangeRules;\n        //橙色预警规则\n        //msg中包含资产中报警的设备（keys:true）\n        //input: msg.devA,msg.devB\n        //rule: [{andRule:[devA,devB]},{andRule:[devC]}]\n        //\n        var orange = false;\n        for (var idx = 0; idx < orangeRules.length; idx++) {\n            andRules = orangeRules[idx].andRule;\n            //andRules:['devA','devB'],msg必须全部都具备\n            for (var jdx = 0; jdx < andRules.length; jdx++) {\n                var alarmDev = andRules[jdx];\n                if (!msg[alarmDev]) {\n                    // orange = false;\n                    break;\n                }\n                if (jdx === andRules.length - 1)\n                    orange = true;\n            }\n            if (!orange) { // test next rule (or)\n                continue;\n            } else\n                break;\n        }\n        if (orange)\n            return 'orange';\n\n        var blue = false;\n        for (var idx = 0; idx < blueRules.length; idx++) {\n            andRules = blueRules[idx].andRule;\n            //andRules:['devA','devB'],msg必须全部都具备\n            for (var jdx = 0; jdx < andRules.length; jdx++) {\n                var alarmDev = andRules[jdx];\n                if (!msg[alarmDev]) {\n                    // blue = false;\n                    break;\n                }\n                if (jdx === andRules.length - 1)\n                    blue = true;\n            }\n            if (!blue) { // test next rule (or)\n                continue;\n            } else\n                break;\n        }\n        if (blue)\n            return 'blue';\n    } else\n        return;\n}\n\nfunction nextRelation(metadata, msg) {\n    var condition = 'default';\n    switch (tryRules(metadata.asset_id, msg)) {\n        case 'blue':\n            // code\n            condition = ['blue'];\n            break;\n        case 'orange':\n            condition = ['orange'];\n            break;\n        default:\n            condition = ['disappear']\n            break;\n    }\n    return condition;\n}\n\nreturn nextRelation(metadata, msg);"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 971,
          "layoutY": 330
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "更新资产预警属性",
        "debugMode": false,
        "configuration": {
          "scope": "SERVER_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 653,
          "layoutY": 330
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "严重超标蓝色预警",
        "debugMode": false,
        "configuration": {
          "jsScript": "msgType = 'POST_ATTRIBUTES_REQUEST';\nmsg.asset_warning_level = 'BLUE';\nreturn {msg: msg, metadata: metadata, msgType: msgType};"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 969,
          "layoutY": 422
        },
        "type": "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode",
        "name": "更新资产预警属性",
        "debugMode": false,
        "configuration": {
          "scope": "SERVER_SCOPE"
        }
      },
      {
        "additionalInfo": {
          "layoutX": 651,
          "layoutY": 422
        },
        "type": "org.thingsboard.rule.engine.transform.TbTransformMsgNode",
        "name": "严重超标黄色预警",
        "debugMode": false,
        "configuration": {
          "jsScript": "msgType = 'POST_ATTRIBUTES_REQUEST';\nmsg.asset_warning_level = 'YELLOW';\nreturn {msg: msg, metadata: metadata, msgType: msgType};"
        }
      }
    ],
    "connections": [
      {
        "fromIndex": 0,
        "toIndex": 1,
        "type": "Success"
      },
      {
        "fromIndex": 1,
        "toIndex": 4,
        "type": "Success"
      },
      {
        "fromIndex": 2,
        "toIndex": 5,
        "type": "Success"
      },
      {
        "fromIndex": 3,
        "toIndex": 2,
        "type": "Success"
      },
      {
        "fromIndex": 4,
        "toIndex": 3,
        "type": "Success"
      },
      {
        "fromIndex": 5,
        "toIndex": 7,
        "type": "blue"
      },
      {
        "fromIndex": 5,
        "toIndex": 9,
        "type": "orange"
      },
      {
        "fromIndex": 7,
        "toIndex": 6,
        "type": "Success"
      },
      {
        "fromIndex": 9,
        "toIndex": 8,
        "type": "Success"
      }
    ],
    "ruleChainConnections": null
  }
}